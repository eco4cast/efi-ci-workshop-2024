<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.146">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Cyberinfrastructure for Efficient Ecological Forecasting -  Model Output Standards</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../images/EFI_Logo-1.jpg" rel="icon" type="image/jpeg">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Cyberinfrastructure for Efficient Ecological Forecasting</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-workshop-summary" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Workshop Summary</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-workshop-summary">    
        <li>
    <a class="dropdown-item" href="../workshopsummary/index.html" rel="" target="">
 <span class="dropdown-text">Workshop Summary</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../workshopsummary/brief.html" rel="" target="">
 <span class="dropdown-text"><i class="fa-solid fa-arrow-right" aria-label="arrow-right"></i> EFI-CI Briefing Paper</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../workshopsummary/report.html" rel="" target="">
 <span class="dropdown-text"><i class="fa-solid fa-arrow-right" aria-label="arrow-right"></i> EFI-CI Workshop Report</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-ci-handbook" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">CI Handbook</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-ci-handbook">    
        <li>
    <a class="dropdown-item" href="../ci_handbook/index.html" rel="" target="">
 <span class="dropdown-text">CI Handbook</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../ci_handbook/model-output-standards.html" rel="" target="">
 <span class="dropdown-text"><i class="fa-solid fa-arrow-right" aria-label="arrow-right"></i> Model Output Standards</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../ci_handbook/design_justice.html" rel="" target="">
 <span class="dropdown-text"><i class="fa-solid fa-arrow-right" aria-label="arrow-right"></i> Design Justice</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../ci_handbook/workflow_design.html" rel="" target="">
 <span class="dropdown-text"><i class="fa-solid fa-arrow-right" aria-label="arrow-right"></i> Workflow Design</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../ci_handbook/modularity.html" rel="" target="">
 <span class="dropdown-text"><i class="fa-solid fa-arrow-right" aria-label="arrow-right"></i> Modularity</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../ci_handbook/data_standards.html" rel="" target="">
 <span class="dropdown-text"><i class="fa-solid fa-arrow-right" aria-label="arrow-right"></i> Data Standards</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../ci_handbook/cloud_computing.html" rel="" target="">
 <span class="dropdown-text"><i class="fa-solid fa-arrow-right" aria-label="arrow-right"></i> Cloud Computing</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../ci_handbook/continuous_integration.html" rel="" target="">
 <span class="dropdown-text"><i class="fa-solid fa-arrow-right" aria-label="arrow-right"></i> Continuous Integration &amp; Delivery</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../ci_handbook/example.html" rel="" target="">
 <span class="dropdown-text"><i class="fa-solid fa-arrow-right" aria-label="arrow-right"></i> Example Forecast CI</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-reference" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Reference</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-reference">    
        <li>
    <a class="dropdown-item" href="../reference/index.html" rel="" target="">
 <span class="dropdown-text">Reference</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../reference/EFI_CI_reference.html" rel="" target="">
 <span class="dropdown-text"><i class="fa-solid fa-arrow-right" aria-label="arrow-right"></i> Acronyms and Definitions</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../reference/participants.html" rel="" target="">
 <span class="dropdown-text"><i class="fa-solid fa-arrow-right" aria-label="arrow-right"></i> Participants</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/eco4cast/efi-ci-workshop-2024" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../ci_handbook/model-output-standards.html"><i class="fa-solid fa-arrow-right" aria-label="arrow-right"></i> Model Output Standards</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation docked overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../ci_handbook/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">CI Handbook</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../ci_handbook/model-output-standards.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><i class="fa-solid fa-arrow-right" aria-label="arrow-right"></i> Model Output Standards</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../ci_handbook/design_justice.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><i class="fa-solid fa-arrow-right" aria-label="arrow-right"></i> Design Justice</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../ci_handbook/workflow_design.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><i class="fa-solid fa-arrow-right" aria-label="arrow-right"></i> Workflow Design</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../ci_handbook/modularity.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><i class="fa-solid fa-arrow-right" aria-label="arrow-right"></i> Modularity</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../ci_handbook/data_standards.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><i class="fa-solid fa-arrow-right" aria-label="arrow-right"></i> Data Standards</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../ci_handbook/cloud_computing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><i class="fa-solid fa-arrow-right" aria-label="arrow-right"></i> Cloud Computing</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../ci_handbook/continuous_integration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><i class="fa-solid fa-arrow-right" aria-label="arrow-right"></i> Continuous Integration &amp; Delivery</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../ci_handbook/example.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><i class="fa-solid fa-arrow-right" aria-label="arrow-right"></i> Example Forecast CI</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#importance-of-standardizing-model-output" id="toc-importance-of-standardizing-model-output" class="nav-link active" data-scroll-target="#importance-of-standardizing-model-output">Importance of Standardizing Model Output</a></li>
  <li><a href="#model-output-standards" id="toc-model-output-standards" class="nav-link" data-scroll-target="#model-output-standards">Model Output Standards</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/eco4cast/efi-ci-workshop-2024/edit/main/ci_handbook/model-output-standards.qmd" class="toc-action">Edit this page</a></p><p><a href="https://github.com/eco4cast/efi-ci-workshop-2024/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><i class="fa-solid fa-arrow-right" aria-label="arrow-right"></i> Model Output Standards</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="importance-of-standardizing-model-output" class="level2">
<h2 class="anchored" data-anchor-id="importance-of-standardizing-model-output">Importance of Standardizing Model Output</h2>
<p>Agreed-upon model standards and conventions, such as variable names and data structures, are essential for achieving model interoperability and developing shared, reusable tools. Establishing these conventions enhance data consistency, facilitate dissemination, and support efficient data analysis.</p>
<p>By leveraging existing community standards and conventions within the broader modeling community, researchers can enhance engagement and make their products more valuable to a wider audience. <strong>We recommend adopting the model output standard described by <span class="citation" data-cites="dietze2023community">(<a href="#ref-dietze2023community" role="doc-biblioref">Dietze et al. 2023</a>)</span> for all ecological forecasts</strong>. As a community-driven convention, contributions to further develop and improve this standard are highly encouraged.</p>
</section>
<section id="model-output-standards" class="level2">
<h2 class="anchored" data-anchor-id="model-output-standards">Model Output Standards</h2>
<p>The model output standards outlined by <span class="citation" data-cites="dietze2023community">(<a href="#ref-dietze2023community" role="doc-biblioref">Dietze et al. 2023</a>)</span> build upon the Climate and Forecast (<a href="http://cfconventions.org/">CF</a>) conventions <span class="citation" data-cites="eaton2003netcdf">(<a href="#ref-eaton2003netcdf" role="doc-biblioref">Eaton et al. 2003</a>)</span> and Cooperative Ocean/Atmosphere Research Data Service (<a href="https://ferret.pmel.noaa.gov/noaa_coop/coop_cdf_profile.html">COARDS</a>) conventions.</p>
<p>For all model output, the recommended order of dimensions should be T, Z, Y, X, U, where:</p>
<ul>
<li><strong>T</strong>: Time</li>
<li><strong>Z</strong>: Vertical dimension</li>
<li><strong>Y</strong>: Latitude</li>
<li><strong>X</strong>: Longitude</li>
<li><strong>U</strong>: Uncertainty (e.g., ensemble member or summary statistic)</li>
</ul>
<p>The following dimension names should be used as listed in order to describe T, Z, Y, X, U:</p>
<table class="table">
<thead>
<tr class="header">
<th>Dimension</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><em>reference_datetime</em></td>
<td><strong>REQUIRED</strong>. ISO 8601 (<a href="https://www.iso.org/standard/70907.html">ISO, 2019</a>) datetime the forecast starts from (aka issue time). Datetimes are allowed to be earlier than the <em>reference_datetime</em> if a reanalysis/reforecast is run before the start of the forecast period.</td>
</tr>
<tr class="even">
<td><em>datetime</em></td>
<td><strong>REQUIRED</strong>. ISO 8601 (<a href="https://www.iso.org/standard/70907.html">ISO, 2019</a>) datetime being predicted and follows <a href="http://cfconventions.org/cf-conventions/cf-conventions.html#time-coordinate">CF convention</a>.</td>
</tr>
<tr class="odd">
<td><em>duration</em></td>
<td><strong>REQUIRED</strong>. Specifies the time step of the prediction. Use <code>P1D</code> for a daily prediction, <code>P1W</code> for a weekly prediction, and <code>PT30M</code> for a 30-minute prediction. The format should adhere to <a href="https://en.wikipedia.org/wiki/ISO_8601#Durations">ISO 8601 duration</a>.</td>
</tr>
<tr class="even">
<td><em>depth</em> or <em>height</em></td>
<td><strong>REQUIRED IF STORING MULTIPLE Z DIMENSIONS</strong>. No single standard name for the Z dimension. Where possible, use <a href="https://cfconventions.org/cf-conventions/cf-conventions.html#vertical-coordinate">CF conventions</a> for vertical dimension names and attributes.</td>
</tr>
<tr class="odd">
<td><em>lat</em> or <em>Y</em></td>
<td><strong>REQUIRED IF PREDICTING ON GRID</strong>. Latitude (units = <code>degrees_north</code>).</td>
</tr>
<tr class="even">
<td><em>lon</em> or <em>X</em></td>
<td><strong>REQUIRED IF PREDICTING ON GRID</strong>. Longitude (units = <code>degrees_east</code>) is the default spatial coordinate. The alternative use of Y, X for spatial coordinates should conform to the CF convention and requires additional metadata about grids and projections.</td>
</tr>
<tr class="odd">
<td><em>site_id</em></td>
<td><strong>REQUIRED IF NOT PREDICTING ON A GRID</strong>. For predictions that are not on a spatial grid, use a site dimension that maps to a more detailed geometry (points, polygons, etc.). <em>site_id</em> should be used when making predictions that map to a stream network geofabric, for example.</td>
</tr>
<tr class="even">
<td><em>family</em></td>
<td><strong>REQUIRED</strong>. Describes the distribution of the prediction (e.g., <code>normal</code> for a normal distribution). For ensemble predictions, use <code>ensemble</code>. If the predictions yield a single realization (i.e., there is no associated uncertainty), it is preferred to specify <code>ensemble</code> with the ensemble size set to 1. If this dimension remains constant, it is acceptable to define <em>family</em> as a variable attribute, provided that the file format supports this (e.g., netCDF). Refer to <a href="https://esajournals.onlinelibrary.wiley.com/action/downloadSupplement?doi=10.1002%2Fecs2.4686&amp;file=ecs24686-sup-0001-AppendixS1.pdf">appendix S1</a> of <span class="citation" data-cites="dietze2023community">(<a href="#ref-dietze2023community" role="doc-biblioref">Dietze et al. 2023</a>)</span> for supported <em>family</em> and <em>parameter</em> names.</td>
</tr>
<tr class="odd">
<td><em>parameter</em></td>
<td><strong>REQUIRED</strong>. For ensemble predictions, specify integers from <code>1</code> to <code>Ne</code> (where <code>Ne</code> represents the total size of the ensemble). For named distributions, indicate the parameter or statistic being specified (e.g., a normal distribution would have <code>mean</code> and <code>sigma</code> as the values in the <em>parameter</em> column).</td>
</tr>
<tr class="even">
<td><em>variable</em></td>
<td><strong>REQUIRED</strong>. Standardized variable name of what is being predicted. We recommend using <a href="https://csdms.colorado.edu/wiki/CSDMS_Standard_Names">CSDMS Standard Names</a>. For example, maximum stream temperature would be named <code>channel_water_surface_water__max_of_temperature</code>. However, existing widely-used variable names (e.g., <code>max_temp_c</code>) are also acceptable.</td>
</tr>
<tr class="odd">
<td><em>prediction</em></td>
<td><strong>REQUIRED</strong>. Predicted value for the parameter in the <em>parameter</em> column. For an ensemble forecast, the value is the prediction for the ensemble member. For a distribution forecast, the value corresponds to the parameter associated with the distribution in the <em>parameter</em> column.</td>
</tr>
</tbody>
</table>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-dietze2023community" class="csl-entry" role="listitem">
Dietze, Michael C, R Quinn Thomas, Jody Peters, Carl Boettiger, Gerbrand Koren, Alexey N Shiklomanov, and Jaime Ashander. 2023. <span>“A Community Convention for Ecological Forecasting: Output Files and Metadata Version 1.0.”</span> <em>Ecosphere</em> 14 (11): e4686.
</div>
<div id="ref-eaton2003netcdf" class="csl-entry" role="listitem">
Eaton, Brian, Jonathan Gregory, Bob Drach, Karl Taylor, Steve Hankin, John Caron, Rich Signell, et al. 2003. <span>“NetCDF Climate and Forecast (CF) Metadata Conventions.”</span> <em>URL: Http://Cfconventions. Org/Data/Cf-Conventions/Cf-Conventions-1.8/Cf-Conventions. Pdf</em>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    if (id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        for (let i = 0; i < 2; i++) {
          container.appendChild(note.children[i].cloneNode(true));
        }
        return container.innerHTML
      } else {
        return note.innerHTML;
      }
    } else {
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      try { hash = new URL(url).hash; } catch {}
      const id = hash.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note !== null) {
        try {
          const html = processXRef(id, note);
          instance.setContent(html);
        } finally {
          instance.enable();
          instance.show();
        }
      } else {
        // See if we can fetch this
        fetch(url.split('#')[0])
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.getElementById(id);
          console.log(htmlDoc.body.innerHTML);
          if (note !== null) {
            const html = processXRef(id, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>